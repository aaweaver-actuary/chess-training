# Review Domain & Scheduler Foundation – Atomic Task List

1. **Milestone 1 – Type-safe identifiers & card aggregates:** Define `PositionId`, `EdgeId`, `MoveId`, `CardId`, and related newtype wrappers in a dedicated module, updating all serde/Avro schemas and public constructors to accept/emit the new wrappers so raw `u64` values disappear from the API surface.
2. **Milestone 1 – Type-safe identifiers & card aggregates:** Introduce a concrete `CardAggregate` struct with `new_opening`/`new_tactic` constructors and an `apply_review` helper that hides SM-2 field mutation, reusing existing grade utilities to enforce scheduler invariants.
3. **Milestone 1 – Type-safe identifiers & card aggregates:** Sweep existing crate call sites to migrate to the new identifiers and aggregate constructors, replacing direct state mutation with the encapsulated API and expanding unit/property tests to cover conversions and review updates.
4. **Milestone 2 – OpeningGraph & unlock symmetry:** Build an `OpeningGraph` builder that consumes existing `RepertoireMove` collections, materialises adjacency maps, and exposes navigation helpers (children, parents, path-to) while preserving the ability to flatten back to the legacy edge list for serialization.
5. **Milestone 2 – OpeningGraph & unlock symmetry:** Replace manual vector scans in repertoire consumers with `OpeningGraph` queries, adding DAG traversal/unit tests (including prefix deduplication) to verify parity with legacy behaviour.
6. **Milestone 2 – OpeningGraph & unlock symmetry:** Introduce symmetric unlock enums aligned to `CardKind`, plus conversion helpers from `CardAggregate`, and update all serializers/deserializers and downstream payload emitters accordingly.
7. **Milestone 3 – Importer-to-domain bridge:** Implement a Rust adapter that streams importer artefacts into the redesigned domain types, mapping deterministic IDs to the new wrappers and producing validated card aggregates ready for persistence.
8. **Milestone 3 – Importer-to-domain bridge:** Extend the card-store integration to persist the adapted openings/cards, ensuring the adapter enforces invariant-safe inserts and unlock logging as outlined for the import-to-card pipeline.
9. **Milestone 3 – Importer-to-domain bridge:** Author integration tests that exercise importer → adapter → store flows, asserting schema compatibility and leveraging the new review-domain abstractions without leaking internal state.
10. **Milestone 4 – Scheduler HTTP service:** Expose an Axum (or similar) HTTP layer for `scheduler-core`, implementing `/queue` and `/grade` endpoints backed by the redesigned store contracts so the gateway finally has a concrete scheduler to call.
11. **Milestone 4 – Scheduler HTTP service:** Build a bridge that translates persisted card-store records into scheduler-ready items, ensuring unlocks and due-card computation operate on the new aggregates without duplicating invariants.
12. **Milestone 4 – Scheduler HTTP service:** Create contract tests (or pact-style fixtures) that validate request/response parity with the Node gateway expectations, covering session ID requirements and payload metrics to avoid future mismatches.
