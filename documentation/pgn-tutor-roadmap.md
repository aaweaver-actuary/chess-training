# PGN Tutor Readiness Assessment

> **Status update (May 2024):** This assessment now informs Workstream 3 (and portions of
> Workstream 2) in [`docs/strategic-roadmap.md`](../docs/strategic-roadmap.md). Use that
> consolidated roadmap for cross-team sequencing while referencing this file for the detailed
> gap analysis and proposed minimum viable path.

## Executive Summary
- The PGN importer crate can parse games, normalise openings and tactics, and persist them into an abstract storage backend while collecting ingestion metrics, but it currently stops at an in-memory store that is not wired into the rest of the system.【F:crates/chess-training-pgn-import/src/importer.rs†L9-L164】【F:crates/chess-training-pgn-import/src/storage.rs†L1-L108】
- The card-store crate defines the persistence trait for positions, edges, cards, reviews, and unlocks plus a thread-safe in-memory implementation, yet no service layer promotes imported data into learner-specific cards or synchronises with the scheduler pipeline.【F:crates/card-store/src/store.rs†L1-L87】【F:crates/card-store/src/memory/in_memory_card_store.rs†L1-L115】
- Scheduler-core implements SM-2 queue construction against an in-memory store, but the crate ships without an HTTP surface or integration glue to the card-store, leaving the Node gateway without a real scheduler to contact.【F:crates/scheduler-core/src/store.rs†L1-L87】【F:crates/scheduler-core/src/main.rs†L1-L1】
- The session gateway exposes REST/WebSocket endpoints that assume a working scheduler service and stricter payloads (e.g., requiring `session_id` on grade/stats) than the current web client provides, causing immediate contract mismatches.【F:apps/session-gateway/src/server.ts†L47-L150】【F:web-ui/src/clients/sessionGateway.ts†L63-L82】【F:web-ui/src/state/sessionStore.ts†L27-L52】
- The React UI still operates on demo data and hand-authored opening patterns, performs orchestration inside components, and auto-starts a dummy session, so it cannot ingest a real PGN or drive a backend review loop yet.【F:web-ui/src/components/PgnImportPane.tsx†L20-L200】【F:web-ui/src/components/SessionRoutes.tsx†L5-L105】【F:web-ui/src/App.tsx†L31-L137】

## Current Implementation Snapshot

### PGN Ingestion
The `chess-training-pgn-import` crate provides an `Importer` that parses PGN strings, enforces FEN/SetUp invariants, normalises moves, and records positions, edges, repertoire links, and tactics while counting per-category metrics.【F:crates/chess-training-pgn-import/src/importer.rs†L9-L165】 Storage is abstracted through the `Storage` trait with an `ImportInMemoryStore` reference implementation, but the emitted artefacts never transition into learner cards or persistent SQL backends yet.【F:crates/chess-training-pgn-import/src/storage.rs†L1-L108】 No CLI or service currently bridges importer output into the card-store.

### Persistence Layer
`card-store` defines the workspace-level storage contract covering position and edge upserts, opening card creation, review recording, and unlock logging, and it offers a RwLock-backed in-memory store with helper routines for canonicalising positions and tracking unlocks.【F:crates/card-store/src/store.rs†L1-L87】【F:crates/card-store/src/memory/in_memory_card_store.rs†L1-L115】 The crate expects callers to supply learner IDs and opening edges but nothing in the workspace currently consumes imported data to create cards, so the store remains unpopulated outside of unit tests.

### Scheduler Core
`scheduler-core` ships the SM-2 configuration, queue builder, and a scheduler façade that depends on a lightweight `CardStore` trait fulfilled by an in-memory map, enabling unit-level validation of due-card selection and unlock ordering.【F:crates/scheduler-core/src/store.rs†L1-L200】 The crate’s binary entry point is a no-op, so there is no HTTP server or long-lived service to satisfy the gateway’s `/queue` and `/grade` calls.【F:crates/scheduler-core/src/main.rs†L1-L1】 Bridging code that converts `card-store` cards into scheduler cards has not been written.

### Session Gateway
The Node gateway exposes `/api/session/start`, `/api/session/grade`, `/api/session/stats`, and `/api/session/end`, validates payloads with zod, maintains in-memory session state, and broadcasts live updates over WebSockets.【F:apps/session-gateway/src/server.ts†L47-L150】【F:apps/session-gateway/src/sessionService.ts†L11-L129】 It expects to call an external HTTP scheduler at `/queue` and `/grade` via the `HttpSchedulerClient`, but that scheduler does not exist yet.【F:apps/session-gateway/src/clients/httpSchedulerClient.ts†L20-L55】 Moreover, the gateway insists on receiving `session_id` for grading and stats, whereas the current web client omits that parameter and cannot satisfy the contract.【F:apps/session-gateway/src/server.ts†L13-L104】【F:web-ui/src/clients/sessionGateway.ts†L63-L82】【F:web-ui/src/state/sessionStore.ts†L27-L52】 Session statistics emitted by the gateway only track review count, accuracy, and latency, so downstream consumers expecting due/completed counts would need augmentation.【F:apps/session-gateway/src/sessionService.ts†L11-L118】

### Web UI
The React app bootstraps from a hard-coded sample snapshot, auto-starts a `demo-user` session on mount, and mixes command routing, import scheduling, and state management inside the top-level component tree.【F:web-ui/src/fixtures/sampleSnapshot.ts†L1-L18】【F:web-ui/src/components/SessionRoutes.tsx†L17-L105】【F:web-ui/src/App.tsx†L31-L137】 PGN detection is limited to two predefined opening patterns and schedules lines locally without persisting them or contacting a backend.【F:web-ui/src/components/PgnImportPane.tsx†L20-L200】 The session store calls the gateway without providing session identifiers, so grade and stats calls would fail against the current API.【F:web-ui/src/state/sessionStore.ts†L27-L52】 The UI separation plan already documents the need to move orchestration logic into a dedicated application layer before further growth.【F:docs/ui-separation-plan.md†L1-L75】

## Existing Roadmaps and Plans
- **UI–Backend Separation Plan.** Establishes an application layer with services (PGN import, opening review), controllers (session, board), and view models to relocate orchestration logic from React components. It recommends incremental extraction starting with PGN import and dashboard view modelling, then replacing the session store with a controller and refactoring command handling.【F:docs/ui-separation-plan.md†L1-L75】
- **Review Domain Redesign Plan.** Proposes introducing type-safe identifiers, card aggregates, an opening graph abstraction, and symmetric unlock representations to harden the domain model before broader integration. It sequences work from type safety to scheduling encapsulation, graph construction, and unlock redesign, noting migration and testing considerations.【F:docs/review-domain-redesign-plan.md†L3-L74】

## Gap Analysis for a Minimal PGN Drill Experience
1. **Importer → Card Store Integration.** There is no service that transforms importer outputs into stored openings or learner cards. Without that bridge, ingesting a PGN cannot produce reviewable items for any user.【F:crates/chess-training-pgn-import/src/importer.rs†L9-L165】【F:crates/card-store/src/store.rs†L1-L87】
2. **Scheduler Service Availability.** The scheduler core lacks a network surface; the gateway’s `/queue` and `/grade` requests have nowhere to land, preventing any review session from starting.【F:apps/session-gateway/src/clients/httpSchedulerClient.ts†L20-L55】【F:crates/scheduler-core/src/main.rs†L1-L1】
3. **API Contract Mismatches.** The gateway requires `session_id` on grade and stats requests and only returns limited metrics, while the web client sends body payloads without the session identifier and expects due/completed counts, so the two components cannot communicate successfully.【F:apps/session-gateway/src/server.ts†L13-L104】【F:apps/session-gateway/src/sessionService.ts†L11-L118】【F:web-ui/src/clients/sessionGateway.ts†L63-L82】【F:web-ui/src/types/gateway.ts†L1-L18】
4. **Frontend Reliance on Mock Data.** The UI still synthesises overview data from a static snapshot and imports lines locally with hard-coded opening patterns, so providing a PGN file will not surface real repertoire content or schedule backend reviews.【F:web-ui/src/fixtures/sampleSnapshot.ts†L1-L18】【F:web-ui/src/components/PgnImportPane.tsx†L20-L200】
5. **Session Lifecycle Control.** React routes automatically call `start('demo-user')`, manage latency timers, and update stats from within components rather than consuming a stable controller/API contract, complicating future integration with real backend state.【F:web-ui/src/components/SessionRoutes.tsx†L33-L105】【F:docs/ui-separation-plan.md†L9-L61】
6. **Domain Model Evolution.** Planned review-domain changes (type-safe IDs, opening graph) are not yet realised, so any integration should either accommodate the current generic types or land those redesign steps first to avoid churn.【F:docs/review-domain-redesign-plan.md†L3-L74】

## Proposed Minimum Viable Path to a PGN Drill Tutor
1. **Implement an Import-to-Card Pipeline.** Build a Rust service/CLI that feeds importer output directly into `card-store`, creating positions, edges, and learner-specific opening cards for a given repertoire owner. This should include deterministic ID mapping between importer edges and card-store entities plus minimal persistence (e.g., SQLite via the card-store abstraction).【F:crates/chess-training-pgn-import/src/storage.rs†L1-L108】【F:crates/card-store/src/store.rs†L1-L87】
2. **Expose a Scheduler HTTP Service.** Wrap `scheduler-core` in an Axum (or similar) API that offers `/queue` and `/grade` endpoints compatible with the gateway client, backed by a store implementation that reads cards from card-store or a bridge adapter. Ensure unlock logging and due-card computation operate on the imported repertoire.【F:crates/scheduler-core/src/store.rs†L1-L200】【F:apps/session-gateway/src/clients/httpSchedulerClient.ts†L20-L55】
3. **Align Gateway and Web Client Contracts.** Update the gateway to return the metrics the UI expects (or adjust the UI), and modify the web client to include `session_id` in grade/stats calls. Introduce a typed client method that injects the ID automatically after session start.【F:apps/session-gateway/src/server.ts†L47-L104】【F:web-ui/src/clients/sessionGateway.ts†L63-L82】【F:web-ui/src/types/gateway.ts†L1-L18】
4. **Refactor the UI Around the Application Layer.** Follow the UI separation plan to extract session control, PGN import services, and dashboard view models so components consume structured data rather than managing orchestration. Replace the sample snapshot with live data pulled from the gateway and hook the import pane to a backend endpoint that triggers the new PGN ingestion pipeline.【F:docs/ui-separation-plan.md†L1-L75】【F:web-ui/src/components/PgnImportPane.tsx†L20-L200】【F:web-ui/src/components/SessionRoutes.tsx†L17-L105】
5. **Deliver End-to-End Smoke Tests.** Script a workflow that ingests a sample PGN, spins up the scheduler service, session gateway, and web UI, and confirms that the learner can step through the opening line while grades propagate through the stack. Cover edge cases (missing session IDs, invalid PGNs) with automated tests to prevent regressions.【F:apps/session-gateway/src/server.ts†L47-L120】【F:crates/chess-training-pgn-import/src/importer.rs†L107-L138】

By completing these steps, the repository will progress from disconnected libraries to a minimal, full-stack loop where a PGN file can be imported, scheduled, and drilled through the integrated UI.
